module.exports = function(mod,global,registry) {
  try {
    return require(mod);
  } catch (e){
    if(e.code == 'MODULE_NOT_FOUND'){

      var npm = require('./npm-utils'),
          existsG = require('fs').existsSync(require('path').join(npm.globalDirectory,mod)),
          exists = require('fs').existsSync(require('path').join(process.cwd(),'node_modules',mod));
      
      if (exists){
        return require(require('path').join(process.cwd(),'node_modules',mod));
      } else {
        if (existsG) {
          return require(require('path').join(npm.globalDirectory,mod));
        }
        registry = registry || null;
        global = global || false;
        if (typeof global === 'string'){
          registry = global;
          global = false;
        }
        npm.installSync({
          package: mod,
          name: mod,
          global: global,
          registry: registry
        });
        return require(mod);
      }
    } else {
      throw e;
    }
  }
};